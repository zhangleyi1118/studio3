# LED灯带控制系统 - 接线说明

## 系统概述

本系统使用ESP32控制14根WS2812B灯带，每根灯带的灯珠数量可以不同（需要在代码中配置）。

## 开发环境配置

### 必需库：FastLED

本系统使用 FastLED 库来控制WS2812B灯带。在编译代码之前，必须先安装此库。

#### 方法1：使用Arduino IDE安装（推荐）

1. 打开 Arduino IDE
2. 点击 **工具** → **管理库...**（或按 `Ctrl+Shift+I`）
3. 在搜索框中输入 `FastLED`
4. 找到 **FastLED by Daniel Garcia**，点击 **安装**
5. 等待安装完成

#### 方法2：使用PlatformIO安装

如果使用 PlatformIO（VS Code 插件），在项目根目录创建或编辑 `platformio.ini` 文件，添加：

```ini
[env:esp32dev]
platform = espressif32
board = esp32dev
framework = arduino
lib_deps = 
    fastled/FastLED@^3.6.0
```

然后 PlatformIO 会自动下载依赖。

#### 方法3：手动安装

1. 访问 FastLED GitHub：https://github.com/FastLED/FastLED
2. 点击 **Code** → **Download ZIP**
3. 在 Arduino IDE 中：**项目** → **加载库** → **添加.ZIP库...**
4. 选择下载的 ZIP 文件

### 验证安装

安装完成后，重新编译代码。如果仍然报错，请检查：
- Arduino IDE 是否选择了正确的开发板（ESP32）
- 是否安装了 ESP32 开发板支持包
- 库是否正确安装（可以在 **项目** → **加载库** → **管理库...** 中搜索确认）

## 硬件要求

- **主控板**：ESP32开发板（推荐ESP32 DevKit V1或类似型号）
- **灯带**：WS2812B RGB LED灯带 × 14根
  - 每根灯带的灯珠数量可以不同
  - 需要在代码中配置每根灯带的具体灯珠数
  - 默认配置为每根300颗（5米，60灯/米）
- **电源**：5V大功率电源（见供电说明）
- **连接线**：杜邦线或导线若干

### 配置灯珠数量

在 `sketch_nov20a.ino` 文件中，找到以下数组并修改每根灯带的灯珠数：

```cpp
const int LEDS_PER_STRIP[NUM_STRIPS] = {
    300, 300, 300, 300, 300, 300, 300, 300, 300, 300, 300, 300, 300, 300
    // ↑    ↑    ↑    ↑    ↑    ↑    ↑    ↑    ↑    ↑    ↑    ↑    ↑    ↑
    // 灯带1 灯带2 灯带3 灯带4 灯带5 灯带6 灯带7 灯带8 灯带9 灯带10 灯带11 灯带12 灯带13 灯带14
};
```

例如，如果灯带1有200颗，灯带2有350颗，则修改为：

```cpp
const int LEDS_PER_STRIP[NUM_STRIPS] = {
    200, 350, 300, 300, 300, 300, 300, 300, 300, 300, 300, 300, 300, 300
};
```

## 引脚连接表

| 灯带编号 | ESP32引脚 | 说明 |
|---------|----------|------|
| 灯带1   | GPIO 2   | 数据线（Data）- 最小引脚 |
| 灯带2   | GPIO 4   | 数据线（Data） |
| 灯带3   | GPIO 5   | 数据线（Data） |
| 灯带4   | GPIO 12  | 数据线（Data） |
| 灯带5   | GPIO 13  | 数据线（Data） |
| 灯带6   | GPIO 14  | 数据线（Data） |
| 灯带7   | GPIO 15  | 数据线（Data） |
| 灯带8   | GPIO 16  | 数据线（Data） |
| 灯带9   | GPIO 17  | 数据线（Data） |
| 灯带10  | GPIO 25  | 数据线（Data） |
| 灯带11  | GPIO 26  | 数据线（Data） |
| 灯带12  | GPIO 27  | 数据线（Data） |
| 灯带13  | GPIO 32  | 数据线（Data） |
| 灯带14  | GPIO 33  | 数据线（Data）- 最大引脚 |

### 引脚说明

- **数据线（Data）**：每根灯带的DI（数据输入）引脚连接到对应的ESP32 GPIO引脚
- **电源线（VCC）**：所有灯带的VCC（5V）连接到外部电源正极（见供电说明）
  - ⚠️ **ESP32不需要连接外部5V电源**，ESP32有自己的供电（USB或板载电源）
- **地线（GND）**：所有灯带的GND连接到外部电源负极，**必须与ESP32的GND共地**
  - ⚠️ **这是必须的！** 不共地会导致数据信号异常，灯带无法正常工作

## 供电说明

### ⚠️ 重要：供电要求

WS2812B灯带在满亮度时，每颗LED约消耗60mA电流。

**计算总电流需求**：
- 统计所有灯带的总灯珠数
- 理论最大电流 = 总灯珠数 × 60mA
- 例如：如果14根灯带总共4200颗LED，则理论最大电流 = 4200 × 60mA = 252A

**电源选择建议**：
- **实际使用电流**：根据亮度设置，通常为理论值的30-50%
- **推荐电源功率**：至少为理论最大功率的50%以上
- 例如：4200颗LED需要至少 **100A @ 5V（500W）** 或更大

### 供电方案

#### 方案1：单电源供电（推荐用于测试）

```
5V大功率电源
├── 正极（+） → 所有灯带VCC（多点注入，见下方说明）
└── 负极（-） → 所有灯带GND + ESP32 GND（共地）
```

**注意**：
- 电源正极需要**多点注入**到灯带，避免末端电压下降
- 建议每2-3米灯带注入一次电源
- 使用较粗的电源线（至少18AWG或更粗）

#### 方案2：多电源并联供电（推荐用于实际应用）

```
电源1（5V 20A） → 灯带1-4
电源2（5V 20A） → 灯带5-8
电源3（5V 20A） → 灯带9-12
电源4（5V 20A） → 灯带13-14 + ESP32
```

所有电源的负极（GND）必须连接在一起，形成共地。

### 电源注入点建议

由于灯带较长（5米），建议在以下位置注入电源：

1. **起始端**：灯带开始处
2. **中间点**：2.5米处（可选，取决于电流需求）
3. **末端**：5米处（强烈推荐）

使用Y型连接器或焊接方式，将电源正极和负极同时连接到这些位置。

## 接线步骤

### 1. 准备材料

- ESP32开发板
- 14根WS2812B灯带（每根5米）
- 5V大功率电源
- 杜邦线或导线
- 电源连接器（如XT60、DC插头等）
- 万用表（用于检查连接）

### 2. 连接数据线

1. 将每根灯带的**DI（数据输入）**引脚连接到对应的ESP32 GPIO引脚
2. 参考上方的引脚连接表
3. 使用杜邦线或焊接方式连接

### 3. 连接电源

1. **连接所有灯带的VCC（5V）**到外部电源正极
   - 建议使用电源分配板或接线端子
   - 确保连接牢固，接触良好

2. **连接所有灯带的GND**到外部电源负极
   - **同时连接到ESP32的GND**（共地非常重要！）

3. **多点电源注入**（推荐）
   - 在每根灯带的起始端和末端都注入电源
   - 使用较粗的电源线（18AWG或更粗）

### 4. 检查连接

使用万用表检查：
- ✅ 所有灯带VCC与电源正极连通（约5V）
- ✅ 所有灯带GND与电源负极连通
- ✅ ESP32 GND与电源负极连通（共地）
- ✅ 数据线连接正确，无短路

## 接线示意图

```
                    ESP32
                    ┌─────┐
                    │     │
    GPIO 13 ────────┤     │
    GPIO 12 ────────┤     │
    GPIO 14 ────────┤     │
    ...             │     │
    GPIO 5  ────────┤     │
                    │     │
    GND ────────────┤     │
                    └─────┘
                      │
                      │ (共地)
                      │
        5V电源 ───────┼────── GND
         (+)          │         (-)
          │           │          │
          ├───────────┼──────────┤
          │           │          │
    ┌─────┴─────┐     │     ┌────┴────┐
    │ 灯带1-14  │     │     │ 灯带1-14│
    │   VCC    │     │     │   GND   │
    └──────────┘     │     └─────────┘
                     │
                  (共地连接)
```

## 注意事项

### ⚠️ 安全警告

1. **电流安全**
   - 确保电源功率足够，避免过载
   - 使用合适的保险丝保护电路
   - 检查所有连接，避免短路

2. **电压安全**
   - WS2812B需要5V供电，不要使用12V或更高电压
   - ESP32工作电压为3.3V，但可以接受5V输入（通过板载稳压器）

3. **共地要求**
   - **必须**将ESP32的GND与灯带电源的GND连接
   - 不共地会导致数据信号异常，灯带无法正常工作

4. **数据线长度**
   - 数据线建议不超过30cm
   - 如果必须使用较长数据线，考虑使用74HC245等信号缓冲器

5. **首次测试**
   - 先连接1-2根灯带测试，确认系统正常
   - 逐步增加灯带数量
   - 使用较低的亮度值（如f,20）进行初始测试

### 引脚限制

ESP32的以下引脚**不能使用**：
- **GPIO 6-11**：Flash/PSRAM引脚（用于程序存储）
- **GPIO 34-39**：仅输入引脚（无输出能力）

当前使用的引脚已避开这些限制。

## 测试步骤

1. **硬件检查**
   - 确认所有连接正确
   - 检查电源电压（应为5V）
   - 确认共地连接

2. **上传程序**
   - 使用Arduino IDE或PlatformIO上传 `sketch_nov20a.ino`
   - 确认上传成功

3. **运行控制脚本**
   ```bash
   python 灯带/control_led.py
   ```

4. **测试命令**
   - `f,20` - 设置低亮度测试
   - `f,50` - 设置中等亮度
   - `s` - 暂停/恢复
   - `q` - 退出

## 故障排查

### 问题1：灯带不亮
- 检查电源连接和电压
- 确认共地连接
- 检查数据线连接
- 尝试降低亮度值

### 问题2：部分灯带不工作
- 检查对应引脚的数据线连接
- 检查该灯带的电源连接
- 尝试交换数据线测试

### 问题3：颜色异常或闪烁
- 检查共地连接（最常见原因）
- 检查电源是否足够
- 检查数据线是否有干扰
- 尝试降低亮度

### 问题4：ESP32重启或死机
- 检查电源功率是否足够
- 检查是否有短路
- 尝试减少同时点亮的灯带数量

## 技术支持

如遇到问题，请检查：
1. 串口监视器输出（115200波特率）
2. Python控制脚本的错误信息
3. 硬件连接是否正确
4. 电源是否足够

---

**最后更新**：2024年
**版本**：1.0
