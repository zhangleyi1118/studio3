---
name: 潮汐桥粒子流系统重构
overview: 重构潮汐桥视觉效果，从简单的波浪效果改为完整的粒子流系统，包括底色渐变、亮核区呼吸、能量粒子流、加速区、潮汐拉伸波和不稳定白闪，实现"能量被拉扯加速传输"的物理直觉可视化。
todos:
  - id: "1"
    content: 扩展 TidalStripState 结构体，添加粒子系统、闪爆系统和全局时间字段
    status: completed
  - id: "2"
    content: 定义 Particle 结构体和 MAX_PARTICLES 常量
    status: completed
  - id: "3"
    content: 更新参数定义：移除旧波浪参数，添加新粒子系统、亮核区、加速区、拉伸波、白闪参数
    status: completed
  - id: "4"
    content: 实现工具函数：lerp、smoothstep、randomFloat
    status: completed
  - id: "5"
    content: 实现底色渐变函数 getGradientColor(u)
    status: completed
    dependencies:
      - "4"
  - id: "6"
    content: 实现粒子系统：spawnParticle、updateParticles、renderParticles
    status: completed
    dependencies:
      - "1"
      - "2"
      - "4"
  - id: "7"
    content: 实现亮核区函数 calculateCoreBoost
    status: completed
    dependencies:
      - "4"
  - id: "8"
    content: 实现潮汐拉伸波函数 calculateStretchWave
    status: completed
    dependencies:
      - "4"
  - id: "9"
    content: 实现白闪系统：updateFlashEffect、getFlashContribution
    status: completed
    dependencies:
      - "1"
      - "4"
  - id: "10"
    content: 重写 calculateTidalLEDColor 主渲染函数，整合所有效果
    status: completed
    dependencies:
      - "5"
      - "6"
      - "7"
      - "8"
      - "9"
  - id: "11"
    content: 更新主循环：移除旧波浪更新，添加粒子系统更新和新的渲染逻辑
    status: completed
    dependencies:
      - "10"
  - id: "12"
    content: 更新 setup() 函数：初始化新的状态字段
    status: completed
    dependencies:
      - "1"
      - "2"
---

# 潮汐桥粒子流系统重构

## 目标

将潮汐桥从简单的波浪效果重构为完整的"能量传输"可视化系统，包含粒子流、亮核区、加速区、潮汐拉伸波和白闪效果。

## 核心改动

### 1. 数据结构扩展 (`灯带/sketch_nov20a/sketch_nov20a.ino`)

**扩展 `TidalStripState` 结构体**（约147-153行）：

- 移除 `wavePosition`（不再需要单一波浪位置）
- 添加粒子系统：
- `Particle particles[MAX_PARTICLES]`（粒子数组，建议 MAX_PARTICLES=30）
- `int particleCount`（当前粒子数量）
- `float lastParticleSpawnTime`（上次生成粒子的时间）
- 添加闪爆系统：
- `float flashIntensity`（当前闪爆强度 0-1）
- `float flashStartTime`（闪爆开始时间）
- 添加全局时间：
- `float globalTime`（秒，用于所有周期性效果）

**新增 `Particle` 结构体**：

```cpp
struct Particle {
    float x;        // 位置（0..L-1，LED索引）
    float energy;   // 能量（0.5..1.0）
    float hueShift; // 色相偏移（可选，用于随机化）
};
```



### 2. 参数定义更新（约62-86行）

**移除旧参数**：

- `WAVE_SPEED_MIN/MAX`
- `WAVE_WIDTH`
- `RED_RATIO_MIN/MAX`
- `BLUE_RATIO`
- `BRIGHTNESS_START/END/WHITE`
- `WAVE_BOOST_RATIO`
- `COLOR_TRANSITION_WIDTH`

**添加新参数**：

- 粒子系统：`MAX_PARTICLES=30`
- 亮核区：`CORE_START_U=0.82`（末端18%）
- 加速区：`ACCEL_START_U=0.70`
- 闪爆区：`FLASH_START_U=0.88`
- 底色渐变关键点（RGB值）
- 粒子参数范围（速度、发射率、尾巴长度等）
- 亮核呼吸参数
- 拉伸波参数
- 白闪参数

### 3. 核心函数重写

#### 3.1 底色渐变函数

**新增 `getGradientColor(float u)`**：

- 输入：`u ∈ [0,1]`（位置归一化）
- 输出：`CRGB`（根据关键点插值）
- 关键点：u=0.00(深红), u=0.55(粉白), u=0.80(暖白), u=1.00(冷白)

#### 3.2 粒子系统函数组

**新增 `spawnParticle(TidalStripState* state, int totalLEDs)`**：

- 根据发射率 `rate = 0.2 + 11.8*s^1.6` 决定是否生成新粒子
- 在 `x=0` 位置生成，随机 `energy` 和 `hueShift`

**新增 `updateParticles(TidalStripState* state, int totalLEDs, float deltaTime)`**：

- 更新所有粒子位置
- 应用加速区速度倍增：`speedMul(u) = 1 + accelMask * lerp(0.0, 2.5, s)`
- 移除超出范围的粒子（`x >= totalLEDs`）

**新增 `renderParticles(CRGB* leds, int totalLEDs, TidalStripState* state)`**：

- 对每个LED计算所有粒子的贡献
- 使用高斯衰减或线性衰减计算粒子影响
- 粒子尾巴：后方更长（`tailLong`），前方更短（`tailShort`）

#### 3.3 亮核区函数

**新增 `calculateCoreBoost(float u, float n, float t)`**：

- 计算亮核区呼吸效果
- `coreFreq = 0.15 + 1.05*s`
- `coreAmp = 0.10 + 0.50*s`
- 返回亮度加成系数

#### 3.4 潮汐拉伸波函数

**新增 `calculateStretchWave(float u, float n, float t)`**：

- 计算低频张力波
- `waveFreq = 0.03 + 0.17*s`
- `waveSpeed = 0.2 + 1.8*s`（u/秒）
- 返回亮度调制系数（1.0 + 调制）

#### 3.5 白闪函数

**新增 `updateFlashEffect(TidalStripState* state, float deltaTime)`**：

- 每秒检查一次触发概率（仅当 `n > 85`）
- 概率：`p = ((n-85)/15)^2 * 0.6`
- 触发时设置 `flashIntensity=1.0`，然后指数衰减

**新增 `getFlashContribution(float u, TidalStripState* state)`**：

- 返回当前闪爆对位置 `u` 的贡献
- 仅在 `u ≥ 0.88` 区域有效

#### 3.6 主渲染函数重写

**完全重写 `calculateTidalLEDColor`**（约317-371行）：

- 输入：`ledIndex`, `totalLEDs`, `TidalStripState*`
- 输出：`CRGB`
- 合成顺序：

1. 底色渐变 × `baseGain`（`baseGain = 0.10 + 0.35*s`）
2. + 亮核区颜色 × `coreBoost`
3. + 粒子贡献（在 `renderParticles` 中累积）
4. × 拉伸波调制
5. + 闪爆贡献
6. 最终 clamp 到 [0,255]

### 4. 主循环更新（约660-688行）

**重写潮汐桥渲染部分**：

- 移除 `updateTidalWavePosition` 调用
- 添加：
- `updateParticles`（更新粒子位置）
- `spawnParticle`（生成新粒子）
- `updateFlashEffect`（更新闪爆）
- `state->globalTime` 更新
- 先清空 `leds_tidal1/2`
- 调用新的渲染逻辑（逐LED计算）

### 5. 初始化更新（约384-439行）

**更新 `setup()` 函数**：

- 初始化粒子数组为空
- 初始化闪爆状态为0
- 初始化 `globalTime = 0`
- 移除旧的波浪位置初始化

### 6. 辅助函数

**新增工具函数**：

- `lerp(float a, float b, float t)`：线性插值
- `smoothstep(float edge0, float edge1, float x)`：平滑步进
- `randomFloat(float min, float max)`：随机浮点数

## 实现细节

### 粒子系统优化

- 使用固定大小数组（30个粒子），避免动态内存分配
- 粒子移除时使用"交换到末尾"技巧，保持数组紧凑
- 粒子渲染使用查找表优化距离计算

### 性能考虑

- 粒子数量限制在30个以内
- 使用预计算的查找表（如需要）
- 避免在每帧重复计算常量

### 参数验证

- 所有 `n` 值限制在 [0,100]
- 所有 `u` 值限制在 [0,1]
- 所有颜色值 clamp 到 [0,255]

## 测试要点

1. `n=0`：几乎无效果，底色很暗
2. `n=5`：能看到稀疏粒子流
3. `n=50`：明显的粒子流和亮核呼吸
4. `n=85`：接近连续流，开始出现白闪
5. `n=100`：强烈效果，频繁白闪

## 文件修改清单

- `灯带/sketch_nov20a/sketch_nov20a.ino`：主要修改文件